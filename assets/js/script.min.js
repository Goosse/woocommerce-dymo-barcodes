jQuery(function(a){function c(a,b){var c=[],d=a.split(/\b/),e="",f="";return d.forEach(function(a){var d=e;if(e+=f+a,e.length>b)c.push(d.trim()),e=a,f="";else{var h=e.match(/(.*)(\s+)$/);f=h&&3===h.length&&h[2]||"",e=h&&3===h.length&&h[1]||e}}),e&&c.push(e.trim()),c.join("\n")}if("undefined"==typeof wcb_params)return!1;var b={label:!1,labelSetXml:!1,labelSize:!1,$printerList:a("#woocommerce_product_barcodes_label_size"),init:function(){wcb_params.debug&&(dymo.label.framework.trace=1),dymo.label.framework.init(this.events),a(document).on("change","#woocommerce_product_barcodes_label_size",this.labelPreview),a(document).on("change",".label-preview-option",this.updatePreview),a(document).on("change keyup",".product-label-input",this.updatePrintButton),a(document).on("click","#wcb_print",this.printLabels)},events:function(){b.checkEnvironment(),b.loadLabel(),b.loadPrinters()},checkEnvironment:function(){var b=dymo.label.framework.checkEnvironment();wcb_params.debug&&console.log("dymo environment",b),b.isFrameworkInstalled&&b.isBrowserSupported&&b.isWebServicePresent||a(document.body).hasClass("product_page_product_barcodes")&&0===a(".wcb-error").length&&a(".wrap").find("h2").before('<div class="error wcb-error"><p>'+b.errorDetails+" "+wcb_params.i18n_need_help+"</p></div>")},loadLabel:function(){b.labelSize=wcb_params.label_size,b.$printerList.length&&(b.labelSize=b.$printerList.val()),b.getLabel(b.labelSize)},loadPrinters:function(){dymo.label.framework.getLabelWriterPrintersAsync().then(function(c){if(void 0!==c&&0!==c.length){wcb_params.debug&&console.log("dymo printers",c);for(var d=0;d<c.length;++d){var e=c[d];a("<option>").val(e.name).text(e.name).appendTo("#woocommerce_product_barcodes_dymo_printer"),a("#woocommerce_product_barcodes_dymo_printer").find("option").eq(d+1).prop("selected",!0)}b.updatePrintButton()}})},getLabel:function(a){var c=wcb_params.plugin_url+"/assets/labels/"+a+".label?v="+10*Math.random();dymo.label.framework.openLabelFileAsync(c).then(function(c){b.label=dymo.label.framework.openLabelXml(c.getLabelXml()),b.renderLabel(a),b.printPreview()})},printLabel:function(c){var d=dymo.label.framework.getLabelWriterPrintersAsync(),e=dymo.label.framework.checkEnvironment(),f=a("#woocommerce_product_barcodes_dymo_printer").val();try{if(!e.isFrameworkInstalled||!e.isBrowserSupported)throw e.errorDetails;if(0===d.length)throw wcb_params.i18n_no_printers_error;if(""===f)throw wcb_params.i18n_no_printers_error;if(!1===b.label)throw wcb_params.i18n_label_loaded_error;if(!1===b.labelSetXml)throw wcb_params.i18n_data_loaded_error;dymo.label.framework.printLabelAsync(f,null,b.label,c)}catch(a){alert(a.message||a)}},createLabelSet:function(){var b=new dymo.label.framework.LabelSetBuilder;return a(".wcb_barcodes").each(function(d,e){var f=a(this);if("true"==f.find("input.product-edit-page").val()){console.log("edit page");var g=c(a("#title").val(),maxCharsPerLine),h=a("input#_sku").val(),i=a("#_sale_price").val()?a("#_sale_price").val():a("#_regular_price").val();i="$"+parseFloat(i).toFixed(2)}else var g=c(f.find("input.product-name").val(),maxCharsPerLine),h=f.find("input.product-barcode").val(),i=f.find("input.product-metadata").val();for(var j=f.find("input.product-label-input").val(),k=0;k<parseInt(j);k++){var l=b.addRecord();l.setText("product_name",g),l.setText("metadata",a.trim(i)),l.setText("barcode",h)}}),b},printPreview:function(){b.label&&dymo.label.framework.renderLabelAsync(b.label).then(function(b){var c=a("<img />",{src:"data:image/png;base64,"+b});a("#woocommerce-dymo-print-preview").html(c)})},renderLabel:function(d){var e,f,g,h;e=a(".metadata:checked").map(function(){return a.trim(a(this).parent().text())}).get().join(" "),f=a(".name:checked").map(function(){return c(a.trim(a(this).parent().text(),maxCharsPerLine))}).get().join(" "),g=a(".price:checked").map(function(){return a.trim(a(this).parent().text())}).get().join(" "),h=a(".barcode:checked").map(function(){return a.trim("1234")}).get().join(" "),"small"===d?b.label.setObjectText("price",g):(b.label.setObjectText("metadata",e),b.label.setObjectText("product_name",f)),b.label.setObjectText("barcode",h)},labelPreview:function(){b.labelSize=a(this).val(),b.getLabel(b.labelSize)},updatePreview:function(){b.renderLabel(b.labelSize),b.printPreview()},updatePrintButton:function(){var b=0,c=a("#wcb_print");a(".product-label-input").each(function(){b+=Number(a(this).val())}),b>0?c.prop("disabled",!1).find("span").text(b):c.prop("disabled",!0).find("span").text("")},printLabels:function(a){a.preventDefault(),b.labelSetXml=b.createLabelSet(),b.printLabel(b.labelSetXml)}};a(window).on("load",b.init())});
