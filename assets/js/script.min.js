jQuery(function($){if("undefined"==typeof wcb_params)return!1;var e={label:!1,labelSetXml:!1,labelSize:!1,$printerList:$("#woocommerce_product_barcodes_label_size"),init:function(){wcb_params.debug&&(dymo.label.framework.trace=1),dymo.label.framework.init(this.events),$(document).on("change","#woocommerce_product_barcodes_label_size",this.labelPreview),$(document).on("change",".label-preview-option",this.updatePreview),$(document).on("change keyup",".product-label-input",this.updatePrintButton),$(document).on("click","#wcb_print",this.printLabels)},events:function(){e.checkEnvironment(),e.loadLabel(),e.loadPrinters()},checkEnvironment:function(){var e=dymo.label.framework.checkEnvironment();wcb_params.debug&&console.log("dymo environment",e),e.isFrameworkInstalled&&e.isBrowserSupported&&e.isWebServicePresent||$(document.body).hasClass("product_page_product_barcodes")&&0===$(".wcb-error").length&&$(".wrap").find("h2").before('<div class="error wcb-error"><p>'+e.errorDetails+" "+wcb_params.i18n_need_help+"</p></div>")},loadLabel:function(){e.labelSize=wcb_params.label_size,e.$printerList.length&&(e.labelSize=e.$printerList.val()),e.getLabel(e.labelSize)},loadPrinters:function(){dymo.label.framework.getLabelWriterPrintersAsync().then(function(e){if("undefined"!=typeof e&&0!==e.length){wcb_params.debug&&console.log("dymo printers",e);for(var r=0;r<e.length;++r){var t=e[r];$("<option>").val(t.name).text(t.name).appendTo("#woocommerce_product_barcodes_dymo_printer"),$("#woocommerce_product_barcodes_dymo_printer").find("option").eq(r+1).prop("selected",!0)}}})},getLabel:function(r){var t=wcb_params.plugin_url+"/assets/labels/"+r+".label?v="+10*Math.random();dymo.label.framework.openLabelFileAsync(t).then(function(t){e.label=dymo.label.framework.openLabelXml(t.getLabelXml()),e.renderLabel(r),e.printPreview()})},printLabel:function(r){var t=dymo.label.framework.getLabelWriterPrintersAsync(),a=dymo.label.framework.checkEnvironment(),n=$("#woocommerce_product_barcodes_dymo_printer").val();try{if(!a.isFrameworkInstalled||!a.isBrowserSupported)throw a.errorDetails;if(0===t.length)throw wcb_params.i18n_no_printers_error;if(""===n)throw wcb_params.i18n_no_printers_error;if(!1===e.label)throw wcb_params.i18n_label_loaded_error;if(!1===e.labelSetXml)throw wcb_params.i18n_data_loaded_error;dymo.label.framework.printLabelAsync(n,null,e.label,r)}catch(o){alert(o.message||o)}},createLabelSet:function(){var e=new dymo.label.framework.LabelSetBuilder;return $(".wcb_barcodes").each(function(r,t){for(var a=$(this),n=a.find("input.product-name").val(),o=a.find("input.product-barcode").val(),l=a.find("input.product-metadata").val(),i=a.find("input.product-label-input").val(),c=0;c<parseInt(i);c++){var d=e.addRecord();d.setText("product_name",n),d.setText("metadata",$.trim(l)),d.setText("barcode",o)}}),e},printPreview:function(){e.label&&dymo.label.framework.renderLabelAsync(e.label).then(function(e){var r=$("<img />",{src:"data:image/png;base64,"+e});$("#woocommerce-dymo-print-preview").html(r)})},renderLabel:function(r){var t,a,n,o;t=$(".metadata:checked").map(function(){return $.trim($(this).parent().text())}).get().join(" "),a=$(".name:checked").map(function(){return $.trim($(this).parent().text())}).get().join(" "),n=$(".price:checked").map(function(){return $.trim($(this).parent().text())}).get().join(" "),o=$(".barcode:checked").map(function(){return $.trim("1234")}).get().join(" "),"small"===r?e.label.setObjectText("price",n):(e.label.setObjectText("metadata",t),e.label.setObjectText("product_name",a)),e.label.setObjectText("barcode",o)},labelPreview:function(){e.labelSize=$(this).val(),e.getLabel(e.labelSize)},updatePreview:function(){e.renderLabel(e.labelSize),e.printPreview()},updatePrintButton:function(){var e=0,r=$("#wcb_print");$(".product-label-input").each(function(){e+=Number($(this).val())}),e>0?r.prop("disabled",!1).find("span").text(e):r.prop("disabled",!0).find("span").text("")},printLabels:function(r){r.preventDefault(),e.labelSetXml=e.createLabelSet(),e.printLabel(e.labelSetXml)}};$(window).on("load",e.init())});